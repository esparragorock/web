<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EsparragoRock</title>
    <script src="https://cdn.tiny.cloud/1/o5mqnr5djvfimdhzmr4gy75hs331z92okm1n7ehbjcyz3yc5/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        /* [Mantén todos tus estilos CSS actuales] */
        /* Solo añade esto al final de tu CSS: */
        
        /* Bloqueo de selección de texto para todo el sitio */
        * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Excepciones para el editor */
        #postContent, .tox-tinymce, .tox-tinymce *,
        #adminPassword, #postTitle, #postCategory {
            user-select: auto !important;
            -webkit-user-select: auto !important;
            -moz-user-select: auto !important;
            -ms-user-select: auto !important;
        }
        
        /* Deshabilitar eventos de puntero en áreas no editables */
        body:not(.admin-mode) .admin-panel:not(#adminAccess) {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- [Mantén todo tu HTML actual hasta el script] -->

    <script>
        // CONFIGURACIÓN SEGURA DE TINYMCE
        let tinyMCEInitialized = false;
        
        function initTinyMCE() {
            if (tinyMCEInitialized) return;
            
            tinymce.init({
                selector: '#postContent',
                plugins: 'advlist link image lists',
                toolbar: 'bold italic | bullist numlist | link image',
                menubar: false,
                height: 300,
                setup: function(editor) {
                    editor.on('init', function() {
                        // Asegurar que solo el editor sea editable
                        document.querySelectorAll('*').forEach(el => {
                            if (!el.closest('.tox-tinymce')) {
                                el.contentEditable = 'false';
                            }
                        });
                    });
                }
            });
            
            tinyMCEInitialized = true;
        }

        // GESTIÓN DE AUTENTICACIÓN MEJORADA
        const ADMIN_PASSWORD = "esparragorock2023";
        let isAdmin = false;
        
        function checkAuth() {
            const auth = sessionStorage.getItem('esparragorock-auth');
            if (auth === 'true') {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adminAccess').classList.add('hidden');
                initTinyMCE();
                loadPosts();
            } else {
                logoutAdmin();
            }
        }
        
        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                sessionStorage.setItem('esparragorock-auth', 'true');
                checkAuth();
                alert('Acceso concedido. Modo administrador activado.');
            } else {
                alert('Contraseña incorrecta');
            }
            document.getElementById('adminPassword').value = '';
        }
        
        function logoutAdmin() {
            isAdmin = false;
            sessionStorage.removeItem('esparragorock-auth');
            document.body.classList.remove('admin-mode');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminAccess').classList.remove('hidden');
            
            // Limpiar el editor
            if (tinymce.get('postContent')) {
                tinymce.get('postContent').setContent('');
                tinymce.get('postContent').hide();
            }
        }
        
        // PROTECCIÓN CONTRA EDICIÓN NO DESEADA
        function lockEditing() {
            if (!isAdmin) return;
            
            // Desactivar todo el documento
            document.body.contentEditable = 'false';
            document.documentElement.contentEditable = 'false';
            
            // Solo permitir edición en el editor
            const editor = document.querySelector('#postContent');
            if (editor) editor.contentEditable = 'true';
            
            // Bloquear eventos en áreas no editables
            document.querySelectorAll('*').forEach(el => {
                if (!el.closest('.tox-tinymce') && !el.closest('#adminAccess')) {
                    el.contentEditable = 'false';
                }
            });
        }
        
        // OBSERVADOR DE MUTACIONES PARA BLOQUEAR CAMBIOS DINÁMICOS
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'contenteditable') {
                    const target = mutation.target;
                    if (target.contentEditable === 'true' && !target.closest('.tox-tinymce')) {
                        target.contentEditable = 'false';
                    }
                }
            });
        });
        
        // INICIALIZACIÓN SEGURA
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar observador
            observer.observe(document.body, {
                attributes: true,
                subtree: true,
                attributeFilter: ['contenteditable']
            });
            
            // Verificar autenticación
            checkAuth();
            
            // Protección inicial
            lockEditing();
            
            // Verificación periódica
            setInterval(lockEditing, 1000);
            
            // Botón de logout oculto (puedes moverlo donde prefieras)
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = 'Cerrar sesión';
            logoutBtn.style.position = 'fixed';
            logoutBtn.style.bottom = '10px';
            logoutBtn.style.right = '10px';
            logoutBtn.style.zIndex = '1000';
            logoutBtn.style.padding = '5px 10px';
            logoutBtn.style.backgroundColor = '#f44336';
            logoutBtn.style.color = 'white';
            logoutBtn.style.border = 'none';
            logoutBtn.style.borderRadius = '3px';
            logoutBtn.style.cursor = 'pointer';
            logoutBtn.onclick = logoutAdmin;
            document.body.appendChild(logoutBtn);
            
            // Mostrar solo para admins
            if (!isAdmin) logoutBtn.style.display = 'none';
        });

        // [Mantén el resto de tus funciones igual: showSection, loadPosts, etc.]
        // FUNCIONES DE NAVEGACIÓN
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (sectionId === 'inicio') loadPosts();
        }
        
        function loadPosts() {
            const posts = JSON.parse(localStorage.getItem('esparragorock-posts')) || [];
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            
            if (posts.length === 0 && isAdmin) {
                container.innerHTML = `
                    <div class="entrada">
                        <h2>Bienvenido a EsparragoRock</h2>
                        <p>No hay publicaciones aún. ¡Crea la primera!</p>
                    </div>
                `;
                return;
            }
            
            posts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = 'entrada';
                postElement.innerHTML = `
                    <h2>${post.title}</h2>
                    <span style="color:#666; font-size:0.9em;">${post.category} • ${post.date}</span>
                    <div class="post-content">${post.content}</div>
                    ${isAdmin ? `
                    <div class="entry-actions">
                        <button class="edit-btn" onclick="editPost(${index})">Editar</button>
                        <button class="delete-btn" onclick="deletePost(${index})">Eliminar</button>
                    </div>
                    ` : ''}
                `;
                container.appendChild(postElement);
            });
        }
        
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const post = {
                id: Date.now(),
                title: document.getElementById('postTitle').value,
                category: document.getElementById('postCategory').value,
                content: tinymce.get('postContent').getContent(),
                date: new Date().toLocaleDateString('es-ES')
            };
            
            const posts = JSON.parse(localStorage.getItem('esparragorock-posts')) || [];
            posts.unshift(post);
            localStorage.setItem('esparragorock-posts', JSON.stringify(posts));
            
            this.reset();
            tinymce.get('postContent').setContent('');
            loadPosts();
            alert('Publicación guardada con éxito');
        });
        
        function editPost(index) {
            const posts = JSON.parse(localStorage.getItem('esparragorock-posts')) || [];
            const post = posts[index];
            
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postCategory').value = post.category;
            tinymce.get('postContent').setContent(post.content);
            
            posts.splice(index, 1);
            localStorage.setItem('esparragorock-posts', JSON.stringify(posts));
            
            document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
        }
        
        function deletePost(index) {
            if (confirm('¿Estás seguro de eliminar esta publicación?')) {
                const posts = JSON.parse(localStorage.getItem('esparragorock-posts')) || [];
                posts.splice(index, 1);
                localStorage.setItem('esparragorock-posts', JSON.stringify(posts));
                loadPosts();
            }
        }
        
        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Mensaje enviado con éxito. Nos pondremos en contacto contigo pronto.');
            this.reset();
        });
    </script>
</body>
</html>
